name: PR Labeler and Checker

on:
  pull_request_target:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  process-pr:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: write
      contents: read
    steps:
      - name: Check PR Size and Label
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo, number } = context.issue;
            
            // Get PR details
            const { data: pullRequest } = await github.rest.pulls.get({
              owner,
              repo,
              pull_number: number
            });
            
            // Get PR files
            const { data: files } = await github.rest.pulls.listFiles({
              owner,
              repo,
              pull_number: number
            });
            
            // Calculate total changes
            const totalChanges = files.reduce((sum, file) => sum + file.changes, 0);
            const filesChanged = files.length;
            
            // Create labels based on file types
            const labels = [];
            const fileTypes = new Set();
            
            files.forEach(file => {
              const extension = file.filename.split('.').pop().toLowerCase();
              fileTypes.add(extension);
              
              if (['js', 'jsx', 'ts', 'tsx'].includes(extension)) labels.push('javascript');
              if (['css', 'scss', 'less'].includes(extension)) labels.push('css');
              if (['html', 'htm'].includes(extension)) labels.push('html');
              if (['md', 'txt'].includes(extension)) labels.push('documentation');
              if (['json', 'yaml', 'yml'].includes(extension)) labels.push('config');
              if (file.filename.includes('test') || file.filename.includes('spec')) labels.push('test');
            });
            
            // PR size labels
            if (totalChanges < 50) labels.push('size/xs');
            else if (totalChanges < 200) labels.push('size/small');
            else if (totalChanges < 500) labels.push('size/medium');
            else if (totalChanges < 1000) labels.push('size/large');
            else labels.push('size/xl');
            
            // Add more context-aware labels
            if (pullRequest.title.toLowerCase().includes('fix') || pullRequest.body.toLowerCase().includes('fix:')) labels.push('bug-fix');
            if (pullRequest.title.toLowerCase().includes('feature') || pullRequest.body.toLowerCase().includes('feature:')) labels.push('enhancement');
            if (pullRequest.draft) labels.push('work-in-progress');
            
            // Add unique labels
            const uniqueLabels = [...new Set(labels)];
            
            // Apply labels
            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number: number,
              labels: uniqueLabels
            });
            
            // Add PR analysis comment
            let comment = `### PR åˆ†ææŠ¥å‘Š ğŸ“Š\n\n`;
            comment += `- æ–‡ä»¶å˜æ›´æ•°é‡: **${filesChanged}**\n`;
            comment += `- ä»£ç å˜æ›´è¡Œæ•°: **${totalChanges}**\n`;
            comment += `- æ–‡ä»¶ç±»å‹: **${Array.from(fileTypes).join(', ')}**\n\n`;
            
            // Size analysis
            let sizeComment = '';
            if (totalChanges > 500) {
              sizeComment = 'âš ï¸ è¿™æ˜¯ä¸€ä¸ªè¾ƒå¤§çš„PRï¼Œå»ºè®®è€ƒè™‘æ‹†åˆ†ä¸ºå¤šä¸ªå°å‹PRä»¥ä¾¿äºå®¡æ ¸ã€‚';
            } else if (totalChanges < 50) {
              sizeComment = 'âœ… è¿™æ˜¯ä¸€ä¸ªå°å‹PRï¼Œå®¡æ ¸åº”è¯¥ä¼šå¾ˆå¿«å®Œæˆã€‚';
            } else {
              sizeComment = 'âœ… è¿™æ˜¯ä¸€ä¸ªä¸­ç­‰å¤§å°çš„PRï¼Œæ˜“äºå®¡æ ¸ã€‚';
            }
            
            comment += `#### å¤§å°è¯„ä¼°\n${sizeComment}\n\n`;
            
            // Add automated checks section
            comment += `#### è‡ªåŠ¨æ£€æŸ¥\n`;
            comment += `- [ ] é€šè¿‡æ‰€æœ‰æµ‹è¯•\n`;
            comment += `- [ ] ç¬¦åˆä»£ç è§„èŒƒ\n`;
            comment += `- [ ] å®Œæˆä»£ç å®¡æ ¸\n\n`;
            
            comment += `*è¿™æ˜¯ä¸€ä¸ªè‡ªåŠ¨ç”Ÿæˆçš„è¯„ä¼°ï¼Œç”±PRè‡ªåŠ¨åˆ†æå·¥å…·æä¾›*`;
            
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: number,
              body: comment
            });
